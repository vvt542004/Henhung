<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8" />
    <title>L·ªãch s·ª≠ s·ª± ki·ªán</title>
    <link rel="stylesheet" href="style.css" />
</head>

<body>
    <div class="container-wrapper">
        <header class="navbar">
            <div class="logo">üè† SmartHome</div>
            <div class="controls">
                <a href="index.html" class="nav-link">Trang ch·ªß</a>
                <a href="history.html" class="nav-link">üìú L·ªãch s·ª≠</a>
                <button class="mode-toggle" onclick="toggleMode()">üåô</button>
            </div>
        </header>

        <main>
            <h2>L·ªãch s·ª≠ s·ª± ki·ªán</h2>
            <div class="filters">
                <button onclick="filterEvents('all')">T·∫•t c·∫£</button>
                <button onclick="filterEvents('gas')">Gas</button>
                <button onclick="filterEvents('fire')">L·ª≠a</button>
                <button onclick="filterEvents('rain')">M∆∞a</button>
            </div>
            <div class="history-list" id="history"></div>
        </main>
    </div>

    <script>
        let allEvents = [];

        // ‚öôÔ∏è Chuy·ªÉn nh√£n t·ª´ ti·∫øng Anh sang ti·∫øng Vi·ªát
        const vietnameseLabels = {
            temp: "Nhi·ªát ƒë·ªô",
            hum: "ƒê·ªô ·∫©m",
            gas: "Kh√≠ gas",
            flame: "L·ª≠a",
            rain: "M∆∞a",
            time: "Th·ªùi gian",
            door: "C·ª≠a",
            canopy: "M√°i che",
            raw: null, // B·ªè qua tr∆∞·ªùng n√†y
        };

        function formatTime(dateStr) {
            const d = new Date(dateStr);
            if (isNaN(d.getTime())) return "--"; // ‚úÖ N·∫øu dateStr kh√¥ng h·ª£p l·ªá
            return `${d.toLocaleTimeString('vi-VN')} ng√†y ${d.toLocaleDateString('vi-VN')}`;
        }

        function groupByDate(events) {
            return events.reduce((acc, ev) => {
                const d = new Date(ev.time);
                const dateLabel = isNaN(d.getTime()) ? "Kh√¥ng r√µ ng√†y" : d.toLocaleDateString('vi-VN');
                acc[dateLabel] = acc[dateLabel] || [];
                acc[dateLabel].push(ev);
                return acc;
            }, {});
        }

        function getEventType(msg = '') {
            const text = msg.toLowerCase();
            if (text.includes('gas')) return 'gas';
            if (text.includes('l·ª≠a')) return 'fire';
            if (text.includes('m∆∞a')) return 'rain';
            return 'other';
        }

        function render(events) {
            const container = document.getElementById("history");
            container.innerHTML = "";

            if (!events || events.length === 0) {
                container.innerHTML = "<p>Kh√¥ng c√≥ s·ª± ki·ªán n√†o ƒë∆∞·ª£c ghi nh·∫≠n.</p>";
                return;
            }

            const grouped = groupByDate(events);

            Object.entries(grouped).forEach(([date, logs]) => {
                const groupTitle = document.createElement("h3");
                groupTitle.textContent = `üìÖ Ng√†y ${date}`;
                groupTitle.className = "group-title";
                container.appendChild(groupTitle);

                logs.forEach((item) => {
                    const div = document.createElement("div");
                    const type = getEventType(item.message);
                    div.className = `event-card ${type}`;

                    const details = Object.entries(item.data || {})
                        .filter(([key]) => vietnameseLabels[key] !== null) // lo·∫°i b·ªè raw
                        .map(([key, value]) => {
                            const label = vietnameseLabels[key] || key;
                            return `<div class="event-detail"><strong>${label}</strong>: ${value}</div>`;
                        })
                        .join("");

                    div.innerHTML = `
                    <div class="event-title">${item.message}</div>
                    <div class="event-time">üïí ${formatTime(item.time)}</div>
                    <div class="event-body">${details}</div>
                `;

                    container.appendChild(div);
                });
            });
        }

        function filterEvents(type) {
            if (type === 'all') {
                render(allEvents);
            } else {
                render(allEvents.filter(e => getEventType(e.message) === type));
            }
        }

        function toggleMode() {
            const body = document.body;
            const toggleBtn = document.querySelector(".mode-toggle");
            const isDark = body.classList.toggle("dark");
            toggleBtn.textContent = isDark ? "‚òÄÔ∏è" : "üåô";
            localStorage.setItem("theme", isDark ? "dark" : "light");
        }

        function loadHistory() {
            fetch("/history")
                .then(res => res.json())
                .then(data => {
                    allEvents = Array.isArray(data) ? data.reverse() : [];
                    render(allEvents);
                })
                .catch(err => {
                    console.error("‚ùå Kh√¥ng th·ªÉ t·∫£i l·ªãch s·ª≠:", err);
                    document.getElementById("history").innerHTML =
                        "<p>L·ªói khi t·∫£i l·ªãch s·ª≠ s·ª± ki·ªán.</p>";
                });
        }

        window.addEventListener("DOMContentLoaded", () => {
            const savedTheme = localStorage.getItem("theme");
            const toggleBtn = document.querySelector(".mode-toggle");
            if (savedTheme === "dark") {
                document.body.classList.add("dark");
                toggleBtn.textContent = "‚òÄÔ∏è";
            } else {
                document.body.classList.remove("dark");
                toggleBtn.textContent = "üåô";
            }
        });

        loadHistory();
    </script>

</body>

</html>