<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>Smart Home Controller</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="container-wrapper">
        <header class="navbar">
            <div class="logo">ğŸ  SmartHome</div>
            <div class="controls">
                <a href="/" class="nav-link">Trang chá»§</a>
                <a href="history.html" class="nav-link">ğŸ“œ Lá»‹ch sá»­</a>
                <button class="mode-toggle" onclick="toggleMode()">ğŸŒ™</button>
            </div>
        </header>

        <main>
            <h2>Há»‡ Thá»‘ng NhÃ  ThÃ´ng Minh</h2>
            <div class="container">
                <section class="box">
                    <h3>ğŸ“Š ThÃ´ng sá»‘ cáº£m biáº¿n</h3>
                    <div class="chart-container">
                        <canvas id="tempGauge" width="180" height="180"></canvas>
                        <canvas id="humGauge" width="180" height="180"></canvas>
                        <canvas id="gasBar" width="200" height="180"></canvas>
                    </div>
                    <div class="info-item">ğŸ”¥ Lá»­a: <span id="flame">--</span></div>
                    <div class="info-item">ğŸŒ§ï¸ MÆ°a: <span id="rain">--</span></div>
                    <div class="info-item">â±ï¸ Thá»i gian: <span id="time">--</span></div>
                </section>

                <section class="box control-box">
                    <h3>ğŸ® Äiá»u khiá»ƒn thiáº¿t bá»‹</h3>
                    <button class="btn btn-blue" onclick="sendCommand('open-door')">ğŸšª Má»Ÿ cá»­a</button>
                    <button class="btn btn-red" onclick="sendCommand('close-door')">ğŸ”’ ÄÃ³ng cá»­a</button>
                    <button class="btn btn-blue" onclick="sendCommand('open-canopy')">ğŸŒ‚ Má»Ÿ mÃ¡i che</button>
                    <button class="btn btn-yellow" onclick="sendCommand('close-canopy')">âœ–ï¸ ÄÃ³ng mÃ¡i che</button>

                    <div class="device-status">
                        <p>ğŸšª Cá»­a: <span id="door-status" class="status safe">Äang Ä‘Ã³ng</span></p>
                        <p>ğŸŒ‚ MÃ¡i che: <span id="canopy-status" class="status safe">Äang Ä‘Ã³ng</span></p>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <script>
        let lastFlame = "";
        let lastRain = "";
        let suppressFetch = false;

        const tempChart = new Chart(document.getElementById("tempGauge"), {
            type: "doughnut",
            data: {
                labels: ["Nhiá»‡t Ä‘á»™"],
                datasets: [{
                    label: "Nhiá»‡t Ä‘á»™ (Â°C)",
                    data: [0, 100],
                    backgroundColor: ["#ff6384", "#eee"]
                }]
            },
            options: {
                cutout: "70%",
                plugins: { legend: { display: false } }
            }
        });

        const humChart = new Chart(document.getElementById("humGauge"), {
            type: "doughnut",
            data: {
                labels: ["Äá»™ áº©m"],
                datasets: [{
                    label: "Äá»™ áº©m (%)",
                    data: [0, 100],
                    backgroundColor: ["#36a2eb", "#eee"]
                }]
            },
            options: {
                cutout: "70%",
                plugins: { legend: { display: false } }
            }
        });

        const gasChart = new Chart(document.getElementById("gasBar"), {
            type: "bar",
            data: {
                labels: ["Gas"],
                datasets: [{
                    label: "Gas",
                    data: [0],
                    backgroundColor: ["#ffce56"]
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: true, max: 1000 }
                }
            }
        });

        function fetchData() {
            if (suppressFetch) return; // âœ… Bá» qua náº¿u Ä‘ang táº¡m hoÃ£n cáº­p nháº­t

            fetch("/data")
                .then(res => res.json())
                .then(data => {
                    let sensorData;
                    try {
                        sensorData = JSON.parse(data.raw);
                    } catch (e) {
                        console.error("âŒ KhÃ´ng parse Ä‘Æ°á»£c dá»¯ liá»‡u:", e);
                        return;
                    }

                    updateCharts(sensorData);
                    updateDeviceStatus(sensorData);

                    document.getElementById("flame").textContent = sensorData.flame ?? "--";
                    document.getElementById("rain").textContent = sensorData.rain ?? "--";
                    document.getElementById("time").textContent = sensorData.time ?? "--";

                    if (sensorData.flame === "CÃ³" && lastFlame !== "CÃ³") {
                        logEvent("PhÃ¡t hiá»‡n lá»­a", sensorData);
                    }
                    if (sensorData.rain === "CÃ³" && lastRain !== "CÃ³") {
                        logEvent("PhÃ¡t hiá»‡n mÆ°a", sensorData);
                    }

                    lastFlame = sensorData.flame;
                    lastRain = sensorData.rain;

                    // Ná»n thay Ä‘á»•i
                    const body = document.body;
                    if (sensorData.flame === "PhÃ¡t hiá»‡n" || sensorData.flame === "CÃ³") {
                        body.classList.remove("rain-bg", "gas-bg");
                        body.classList.add("flame-bg");
                    } else if (sensorData.rain === "CÃ³") {
                        body.classList.remove("flame-bg", "gas-bg");
                        body.classList.add("rain-bg");
                    } else if (parseFloat(sensorData.gas ?? 0) > 500) {
                        body.classList.remove("flame-bg", "rain-bg");
                        body.classList.add("gas-bg");
                    } else {
                        body.classList.remove("flame-bg", "rain-bg", "gas-bg");
                    }
                })
                .catch(err => console.error("âŒ Lá»—i khi gá»i /data:", err));
        }

        function updateCharts(data) {
            const temp = parseFloat(data.temp ?? 0);
            const hum = parseFloat(data.hum ?? 0);
            const gas = parseFloat(data.gas ?? 0);

            tempChart.data.datasets[0].data = [temp, 100 - temp];
            humChart.data.datasets[0].data = [hum, 100 - hum];
            gasChart.data.datasets[0].data = [gas];
            tempChart.update();
            humChart.update();
            gasChart.update();
        }

        function updateDeviceStatus(data) {
            const door = data.door ?? "Äang Ä‘Ã³ng";
            const canopy = data.canopy ?? "Äang Ä‘Ã³ng";

            const doorElem = document.getElementById("door-status");
            const canopyElem = document.getElementById("canopy-status");

            doorElem.textContent = door;
            canopyElem.textContent = canopy;

            doorElem.className = "status " + (door === "Äang má»Ÿ" ? "warn" : "safe");
            canopyElem.className = "status " + (canopy === "Äang má»Ÿ" ? "warn" : "safe");
        }

        function logEvent(message, data) {
            fetch("/log", {
                method: "POST",
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message, time: data.time, data })
            })
                .then(res => res.text())
                .then(txt => console.log("ğŸ“¥ Log thÃ nh cÃ´ng:", txt))
                .catch(err => console.error("âŒ Lá»—i ghi log:", err));
        }

        function sendCommand(cmd) {
            fetch(`/command?type=${cmd}`)
                .then(res => res.text())
                .then(data => {
                    console.log("âœ… Server pháº£n há»“i:", data);
                    updateStatusFromCommand(cmd);

                    suppressFetch = true; // âœ… Táº¡m ngÆ°ng cáº­p nháº­t
                    setTimeout(() => suppressFetch = false, 3000); // âœ… Cho server 3 giÃ¢y xá»­ lÃ½
                })
                .catch(err => console.error("âŒ Lá»—i gá»­i lá»‡nh:", err));
        }

        function updateStatusFromCommand(cmd) {
            const doorElem = document.getElementById("door-status");
            const canopyElem = document.getElementById("canopy-status");

            if (cmd === "open-door") {
                doorElem.textContent = "Äang má»Ÿ";
                doorElem.className = "status warn";
            } else if (cmd === "close-door") {
                doorElem.textContent = "Äang Ä‘Ã³ng";
                doorElem.className = "status safe";
            } else if (cmd === "open-canopy") {
                canopyElem.textContent = "Äang má»Ÿ";
                canopyElem.className = "status warn";
            } else if (cmd === "close-canopy") {
                canopyElem.textContent = "Äang Ä‘Ã³ng";
                canopyElem.className = "status safe";
            }
        }

        function toggleMode() {
            const body = document.body;
            const toggleBtn = document.querySelector(".mode-toggle");

            const isDark = body.classList.toggle("dark");
            toggleBtn.textContent = isDark ? "â˜€ï¸" : "ğŸŒ™";
            localStorage.setItem("theme", isDark ? "dark" : "light");
        }

        window.addEventListener("DOMContentLoaded", () => {
            const savedTheme = localStorage.getItem("theme");
            const toggleBtn = document.querySelector(".mode-toggle");

            if (savedTheme === "dark") {
                document.body.classList.add("dark");
                toggleBtn.textContent = "â˜€ï¸";
            } else {
                document.body.classList.remove("dark");
                toggleBtn.textContent = "ğŸŒ™";
            }
        });

        setInterval(fetchData, 1000);
    </script>

</body>

</html>