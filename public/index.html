<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>Smart Home Controller</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="container-wrapper">
        <header class="navbar">
            <div class="logo">🏠 SmartHome</div>
            <div class="controls">
                <a href="/" class="nav-link">Trang chủ</a>
                <a href="history.html" class="nav-link">📜 Lịch sử</a>
                <button class="mode-toggle" onclick="toggleMode()">🌙</button>
            </div>
        </header>

        <main>
            <h2>Hệ Thống Nhà Thông Minh</h2>
            <div class="container">
                <section class="box">
                    <h3>📊 Thông số cảm biến</h3>
                    <div class="chart-container">
                        <canvas id="tempGauge" width="180" height="180"></canvas>
                        <canvas id="humGauge" width="180" height="180"></canvas>
                        <canvas id="gasBar" width="200" height="180"></canvas>
                    </div>
                    <div class="info-item">🔥 Lửa: <span id="flame">--</span></div>
                    <div class="info-item">🌧️ Mưa: <span id="rain">--</span></div>
                    <div class="info-item">⏱️ Thời gian: <span id="time">--</span></div>
                </section>

                <section class="box control-box">
                    <h3>🎮 Điều khiển thiết bị</h3>
                    <button class="btn btn-blue" onclick="sendCommand('open-door')">🚪 Mở cửa</button>
                    <button class="btn btn-red" onclick="sendCommand('close-door')">🔒 Đóng cửa</button>
                    <button class="btn btn-blue" onclick="sendCommand('open-canopy')">🌂 Mở mái che</button>
                    <button class="btn btn-yellow" onclick="sendCommand('close-canopy')">✖️ Đóng mái che</button>

                    <div class="device-status">
                        <p>🚪 Cửa: <span id="door-status" class="status safe">Đang đóng</span></p>
                        <p>🌂 Mái che: <span id="canopy-status" class="status safe">Đang đóng</span></p>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <script>
        let lastFlame = "";
        let lastRain = "";
        let suppressFetch = false;

        const tempChart = new Chart(document.getElementById("tempGauge"), {
            type: "doughnut",
            data: {
                labels: ["Nhiệt độ"],
                datasets: [{
                    label: "Nhiệt độ (°C)",
                    data: [0, 100],
                    backgroundColor: ["#ff6384", "#eee"]
                }]
            },
            options: {
                cutout: "70%",
                plugins: { legend: { display: false } }
            }
        });

        const humChart = new Chart(document.getElementById("humGauge"), {
            type: "doughnut",
            data: {
                labels: ["Độ ẩm"],
                datasets: [{
                    label: "Độ ẩm (%)",
                    data: [0, 100],
                    backgroundColor: ["#36a2eb", "#eee"]
                }]
            },
            options: {
                cutout: "70%",
                plugins: { legend: { display: false } }
            }
        });

        const gasChart = new Chart(document.getElementById("gasBar"), {
            type: "bar",
            data: {
                labels: ["Gas"],
                datasets: [{
                    label: "Gas",
                    data: [0],
                    backgroundColor: ["#ffce56"]
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: true, max: 1000 }
                }
            }
        });

        function fetchData() {
            if (suppressFetch) return; // ✅ Bỏ qua nếu đang tạm hoãn cập nhật

            fetch("/data")
                .then(res => res.json())
                .then(data => {
                    let sensorData;
                    try {
                        sensorData = JSON.parse(data.raw);
                    } catch (e) {
                        console.error("❌ Không parse được dữ liệu:", e);
                        return;
                    }

                    updateCharts(sensorData);
                    updateDeviceStatus(sensorData);

                    document.getElementById("flame").textContent = sensorData.flame ?? "--";
                    document.getElementById("rain").textContent = sensorData.rain ?? "--";
                    document.getElementById("time").textContent = sensorData.time ?? "--";

                    if (sensorData.flame === "Có" && lastFlame !== "Có") {
                        logEvent("Phát hiện lửa", sensorData);
                    }
                    if (sensorData.rain === "Có" && lastRain !== "Có") {
                        logEvent("Phát hiện mưa", sensorData);
                    }

                    lastFlame = sensorData.flame;
                    lastRain = sensorData.rain;

                    // Nền thay đổi
                    const body = document.body;
                    if (sensorData.flame === "Phát hiện" || sensorData.flame === "Có") {
                        body.classList.remove("rain-bg", "gas-bg");
                        body.classList.add("flame-bg");
                    } else if (sensorData.rain === "Có") {
                        body.classList.remove("flame-bg", "gas-bg");
                        body.classList.add("rain-bg");
                    } else if (parseFloat(sensorData.gas ?? 0) > 500) {
                        body.classList.remove("flame-bg", "rain-bg");
                        body.classList.add("gas-bg");
                    } else {
                        body.classList.remove("flame-bg", "rain-bg", "gas-bg");
                    }
                })
                .catch(err => console.error("❌ Lỗi khi gọi /data:", err));
        }

        function updateCharts(data) {
            const temp = parseFloat(data.temp ?? 0);
            const hum = parseFloat(data.hum ?? 0);
            const gas = parseFloat(data.gas ?? 0);

            tempChart.data.datasets[0].data = [temp, 100 - temp];
            humChart.data.datasets[0].data = [hum, 100 - hum];
            gasChart.data.datasets[0].data = [gas];
            tempChart.update();
            humChart.update();
            gasChart.update();
        }

        function updateDeviceStatus(data) {
            const door = data.door ?? "Đang đóng";
            const canopy = data.canopy ?? "Đang đóng";

            const doorElem = document.getElementById("door-status");
            const canopyElem = document.getElementById("canopy-status");

            doorElem.textContent = door;
            canopyElem.textContent = canopy;

            doorElem.className = "status " + (door === "Đang mở" ? "warn" : "safe");
            canopyElem.className = "status " + (canopy === "Đang mở" ? "warn" : "safe");
        }

        function logEvent(message, data) {
            fetch("/log", {
                method: "POST",
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message, time: data.time, data })
            })
                .then(res => res.text())
                .then(txt => console.log("📥 Log thành công:", txt))
                .catch(err => console.error("❌ Lỗi ghi log:", err));
        }

        function sendCommand(cmd) {
            fetch(`/command?type=${cmd}`)
                .then(res => res.text())
                .then(data => {
                    console.log("✅ Server phản hồi:", data);
                    updateStatusFromCommand(cmd);

                    suppressFetch = true; // ✅ Tạm ngưng cập nhật
                    setTimeout(() => suppressFetch = false, 3000); // ✅ Cho server 3 giây xử lý
                })
                .catch(err => console.error("❌ Lỗi gửi lệnh:", err));
        }

        function updateStatusFromCommand(cmd) {
            const doorElem = document.getElementById("door-status");
            const canopyElem = document.getElementById("canopy-status");

            if (cmd === "open-door") {
                doorElem.textContent = "Đang mở";
                doorElem.className = "status warn";
            } else if (cmd === "close-door") {
                doorElem.textContent = "Đang đóng";
                doorElem.className = "status safe";
            } else if (cmd === "open-canopy") {
                canopyElem.textContent = "Đang mở";
                canopyElem.className = "status warn";
            } else if (cmd === "close-canopy") {
                canopyElem.textContent = "Đang đóng";
                canopyElem.className = "status safe";
            }
        }

        function toggleMode() {
            const body = document.body;
            const toggleBtn = document.querySelector(".mode-toggle");

            const isDark = body.classList.toggle("dark");
            toggleBtn.textContent = isDark ? "☀️" : "🌙";
            localStorage.setItem("theme", isDark ? "dark" : "light");
        }

        window.addEventListener("DOMContentLoaded", () => {
            const savedTheme = localStorage.getItem("theme");
            const toggleBtn = document.querySelector(".mode-toggle");

            if (savedTheme === "dark") {
                document.body.classList.add("dark");
                toggleBtn.textContent = "☀️";
            } else {
                document.body.classList.remove("dark");
                toggleBtn.textContent = "🌙";
            }
        });

        setInterval(fetchData, 1000);
    </script>

</body>

</html>